#!/usr/bin/env node

import childProcess from "child_process"
import fs from "fs"
import path from "path"
import os from "os"
import { fileURLToPath } from "url"

const __filename = fileURLToPath(import.meta.url)
const base = "agent-core"

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
    env: process.env,
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  const code = typeof result.status === "number" ? result.status : 0
  process.exit(code)
}

// Support both AGENT_CORE_BIN_PATH and OPENCODE_BIN_PATH for backwards compatibility
const envPath = process.env.AGENT_CORE_BIN_PATH || process.env.OPENCODE_BIN_PATH
if (envPath) {
  run(envPath)
}

const scriptPath = fs.realpathSync(path.resolve(__filename))
const scriptDir = path.dirname(scriptPath)

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
}
const archMap = {
  x64: "x64",
  arm64: "arm64",
  arm: "arm",
}

let platform = platformMap[os.platform()]
if (!platform) {
  platform = os.platform()
}
let arch = archMap[os.arch()]
if (!arch) {
  arch = os.arch()
}
// Support both agent-core and opencode package names (for upstream compatibility)
const agentCoreBase = "agent-core-" + platform + "-" + arch
const opencodeBase = "opencode-" + platform + "-" + arch
const agentCoreBinary = platform === "windows" ? "agent-core.exe" : "agent-core"
const opencodeBinary = platform === "windows" ? "opencode.exe" : "opencode"

function findBinary(startDir) {
  // First check dist/ folder for development builds
  const distCandidate = path.join(startDir, "..", "dist", agentCoreBase, "bin", agentCoreBinary)
  if (fs.existsSync(distCandidate)) {
    return distCandidate
  }

  const candidates = [
    { base: agentCoreBase, binary: agentCoreBinary },
    { base: opencodeBase, binary: opencodeBinary },
  ]

  function resolveCandidate(root, entryName) {
    for (const candidate of candidates) {
      if (!entryName.startsWith(candidate.base)) continue
      const resolved = path.join(root, entryName, "bin", candidate.binary)
      if (fs.existsSync(resolved)) {
        return resolved
      }
    }
  }

  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      const entries = fs.readdirSync(modules, { withFileTypes: true })
      for (const entry of entries) {
        if (!entry.isDirectory()) continue
        if (entry.name.startsWith("@")) {
          const scopeDir = path.join(modules, entry.name)
          const scopedEntries = fs.readdirSync(scopeDir, { withFileTypes: true })
          for (const scopedEntry of scopedEntries) {
            if (!scopedEntry.isDirectory()) continue
            const resolved = resolveCandidate(scopeDir, scopedEntry.name)
            if (resolved) return resolved
          }
          continue
        }
        const resolved = resolveCandidate(modules, entry.name)
        if (resolved) return resolved
      }
    }
    const parent = path.dirname(current)
    if (parent === current) {
      return
    }
    current = parent
  }
}

const resolved = findBinary(scriptDir)
if (!resolved) {
  console.error(
    'It seems that your package manager failed to install the right version of the agent-core CLI for your platform. You can try manually installing the "' +
      base +
      '" package',
  )
  process.exit(1)
}

const candidateRoot = path.resolve(path.dirname(resolved), "..")
if (!process.env.AGENT_CORE_ROOT) {
  const vendorDir = path.join(candidateRoot, "vendor", "personas")
  if (fs.existsSync(vendorDir)) {
    process.env.AGENT_CORE_ROOT = candidateRoot
  }
}

run(resolved)
